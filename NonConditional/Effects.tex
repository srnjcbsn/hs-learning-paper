\documentclass[../Master.tex]{subfiles}
\begin{document}


In~\cite{Walsh2008}, they presented an algorithm on how to learn effects of action schemes limited to non-conditional effects. We will expand on that and generalize some of their concepts.

If we ignore the concept of planning with constants in effects, then we know that all fluent literals in our effects must have variables which are permutations of the action's variables. The set of all those fluent literals we define as $\mathbb{F}$, another way to understand $\mathbb{F}$ is that it is all the possible fluent literals which an action schema can have for its effects.

\begin{definition} 
$\mathbb{F}_A$ is the set of all fluent literals available to an action schema $A$. For ease of use the $A$ can be omitted if it is implied through context.
	\begin{equation*}
		\mathbb{F}_A = \left\{ 
				\begin{gathered}
					p(x_1,\dots,x_n), \\
					\neg p(x_1,\dots,x_n)
				\end{gathered}
					\left|
				\begin{gathered} p \in \mathbb{P}~\land \\
                    \left\{ x_1,\dots,x_{|p|} \right\} \subseteq params(A)
				\end{gathered}				
							\right.\right\}
	\end{equation*}
\end{definition}


\begin{figure}
	\def\firstcircle{(0,0) circle (1.5cm)}
	\def\secondcircle{(0:2cm) circle (1.5cm)}
	\def\thirdcircle{(0:3.8cm) circle (2.9cm)}
	\centering
% Now we can draw the sets:
\begin{tikzpicture}


\draw \firstcircle node[above] {$S$};
\draw \secondcircle node [above] {$S'$};

% Now we want to highlight the intersection of the first and the
% second circle:

\begin{scope}
\clip \firstcircle;
\fill[red] \secondcircle;
\end{scope}

% Next, we want the highlight the intersection of all three circles:

\begin{scope}
\clip \firstcircle;
\clip \secondcircle;
\fill[green] \thirdcircle;
\end{scope}


\end{tikzpicture}
\caption{\label{fig:nca:venn-of-effects} Venn diagram of a state transition. The red area shows predicates which was unaffected, and the Green show effects that was added to S but masked as unaffected because they were already present in S.}

\end{figure}

For any action schema schema it is common that only a small subset of $\mathbb{F}$ are actually present in its effects, 
therefore we differentiate between them by defining whether we have proved or disproved them. 
Initially when a fluent has yet to proved or disproved, we say that it is unproven. 
It then follows that if no fluents are considered unproven then we have complete knowledge for the action schemas effects.


\begin{definition} 
	The proved set $K$ contains which fluents  $f \in \mathbb{F}$ we know are in the action schemas actual effects.
	Conversely the disproved set $D$ define which fluents are for certain not present.
	Those fluents that are neither in $K$ nor in $D$ are said to be in the unproven set $U$.
	
\end{definition}

For $K$, $D$ and $U$ two important invariant holds.

\begin{invariant}[Mutual exclusivity]
	\begin{equation*}
		\begin{split}
		K \cap D & = \emptyset  \\ 
		K \cap U &= \emptyset \\
		D \cap U &= \emptyset
		\end{split}
	\end{equation*}
\end{invariant}

\begin{invariant}[Completeness]
	\begin{equation*}
		U \cup K \cup D = \mathbb{F}
	\end{equation*}
\end{invariant}

In order to prove or disprove the effects through a transition $(S,a,S')$ we must understand what occurs in a state transition.
In a state transition effects are added directly to $S$ in order to form $S'$, therefor we should be able to observe the effects of the action by looking at changes from $S$ to $S'$.  For the special case that predicates are both in $S$ and $S'$ there are two distinct possibilities either they were part of the effects of the action but the effect was already part of $S$ or they were not an effect (see Figure \ref{fig:nca:venn-of-effects}) which is relevant when proving effects. 
To disprove fluents for a single transition we use the idea that fluents that have been grounded which not in the $S'$ cannot be positive effects, and fluents that have been grounded  which are in the $S'$ cannot be negative effects. 
This is logically sound and gives us the following theorem:

\begin{theorem}
	 From a single state-transition $(S,a,S')$ we know that,
	positive fluents are disproved, when grounded they are not in $S'$. Conversely negative fluents when grounded are disproved when they are in $S'$. This gives us the following function to get all disproved effects for a state transition result $S'$:
	
	\begin{equation*}
		 d(S') = \left\{
			f \; | \; f \in \mathbb{F} \land ground(f) \notin S'
			\right\} 
			\cup
			 \left\{
			\neg f \; | \; \neg f \in \mathbb{F} \land ground(f) \in S'
			\right\}
	\end{equation*}
	\begin{proof}[Proof by definition]
		Recall that $S'$ is the result of a union which include the grounded predicates of an action $A$'s effects. Hence, it follows trivially that any predicate $p \notin S'$ can not have been an effect of action $A$.
	Like wise if a grounded fluent is in $S'$ then that fluent cannot have been a negative effect, or it would not have been in $S'$.
	\end{proof}
\end{theorem}


\begin{example}[disproving effects in \texttt{move-h}] \label{ex:nca:moveSucceeded-disproving-effects}
	In case the sokoban agent applies the action $\texttt{move-h}(t_1, t_2)$ in state $S_0$, the resulting state $S_1$ will have the visible effect that the sokoban relocated from $t_1$ to $t_2$. 
	
	
	
	\begin{equation*}
		\begin{split}
		S_0 &=
		\left\{
		\begin{gathered}
			\texttt{sokobanAt}(t_1), \\
			\texttt{clear}(t_2),\\
			\texttt{hAdj}(t_1, t_2)	
		\end{gathered}
		\right\} \\
		S_1 &=
		\left\{
		\begin{gathered}
			\texttt{sokobanAt}(t_2), \\
			\texttt{clear}(t_1), \\
			\texttt{hAdj}(t_1, t_2)			
		\end{gathered}
		\right\} \\		
		\mathbb{F}_{move-h} &= \left\{
		\begin{gathered}
			\texttt{sokobanAt}(to), \texttt{clear}(from), \\
			\texttt{vAdj}(from, to), \texttt{vAdj}(to, from), \\
			\texttt{vAdj}(from, from), \texttt{vAdj}(to, to), \\
			\texttt{hAdj}(from, from), \texttt{hAdj}(to, to), \\
			\texttt{at}(from, to), \texttt{at}(to, from), \\
			\texttt{goal}(from), \texttt{goal}(to)  \\
			\dots
		\end{gathered}
		\right\} \\
		d(S_1) &= \left\{
		\begin{gathered}
			\neg \texttt{sokobanAt}(to), \\
			\neg \texttt{clear}(from), \\
			\neg \texttt{hAdj}(from, to), \\
			\dots \\
			\texttt{sokobanAt}(from), \\
			\texttt{clear}(to), \\
			\dots			
		\end{gathered}
		\right\}
		\end{split}
	\end{equation*}
We see that incorrect effects are correctly disproved, such as moving the sokoban back where it came from $\texttt{sokobanAt}(from)$.
\end{example}


\begin{figure}
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
\begin{tikzpicture}[ele/.style={fill=black,circle,minimum width=.8pt,inner sep=1pt},every fit/.style={ellipse,draw,inner sep=-2pt}]
\node[ele,label=below:{$p(x,y)$}] (a1) at (3,4) {};    
\node[ele,label=below:{$p(y,x)$}] (a2) at (3,3) {};    
\node[ele,label=below:{$p(x,x)$}] (a3) at (3,2) {};
\node[ele,label=below:{$p(y,y)$}] (a4) at (3,1) {};
\node[] (a5) at (3,0.5) {};

\node[ele,,label=below:{$p(o_1,o_2)$}] (b1) at (0,4) {};
\node[ele,,label=below:{$p(o_2,o_1)$}] (b2) at (0,3) {};
\node[ele,,label=below:{$p(o_1,o_1)$}] (b3) at (0,2) {};
\node[ele,,label=below:{$p(o_2,o_2)$}] (b4) at (0,1) {};
\node[] (b5) at (0,0.5) {};

\node[draw,fit= (a1) (a2) (a3) (a4) (a5),minimum width=2cm] {} ;
\node[draw,fit= (b1) (b2) (b3) (b4) (b5),minimum width=2cm] {} ;  
\draw[<-,thick,shorten <=2pt,shorten >=2pt] (a1) -- (b1);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a2) -- (b2);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a3) -- (b3);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a4) -- (b4);
\end{tikzpicture}
		\caption{Unique $A(o_1,o_2)$, \newline $ground^{-1}$ is single-valued}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}
		\centering

\begin{tikzpicture}[ele/.style={fill=black,circle,minimum width=.8pt,inner sep=1pt},every fit/.style={ellipse,draw,inner sep=-2pt}]
\node[ele,label=below:{$p(x,y)$}] (a1) at (3,4) {};    
\node[ele,label=below:{$p(y,x)$}] (a2) at (3,3) {};    
\node[ele,label=below:{$p(x,x)$}] (a3) at (3,2) {};
\node[ele,label=below:{$p(y,y)$}] (a4) at (3,1) {};
\node[] (a5) at (3,0.5) {};

\node[] (b2) at (0,4) {};
\node[ele,,label=below:{$p(o_1,o_1)$}] (b1) at (0,2.5) {};
\node[] (b5) at (0,0.5) {};

\node[draw,fit= (a1) (a2) (a3) (a4) (a5),minimum width=2cm] {} ;
\node[draw,fit= (b1) (b2) (b5),minimum width=2cm] {} ;  
\draw[<-,thick,shorten <=2pt,shorten >=2pt] (a1) -- (b1);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a2) -- (b1);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a3) -- (b1);
\draw[<-,thick,shorten <=2pt,shorten >=2] (a4) -- (b1);
\end{tikzpicture}
		
		\caption{Identical $A(o_1,o_1)$, \newline 
			$ground^{-1}$ is multivalued.}
	\end{subfigure}
	\caption{Shows how $ground^{-1}$ maps to the domain $\mathbb{F}$ from the grounded fluents, for unique and identical action arguments. }
	\label{fig:nca:ground-injectivity}
\end{figure}

In order to understand proving of fluents we must look into how effects are generated, based on the action schema.
The $ground$ function is used to ground fluents from an action's effect. This is important since if we know what fluent a grounded fluent originated from, then that is a proof for that fluent. This means that if a grounded fluent $p \in \Delta S$ returns only one fluent when $ground^{-1}$ is applied to it, i.e. $ground^{-1}(p) = {f}$ then that $f$ has been proved. In other words if $ground$ is injective then $ground^{-1}$ is single-valued and it can thus be applied to all grounded fluents in $\Delta S$ and that will prove all of their respective fluents.
Whether or not $ground$ is injective depends on the arguments of the action (see Figure \ref*{fig:nca:ground-injectivity}).
This gives rise to the following lemma:
\begin{lemma}
If the arguments given to an action $A$ are all unique, then $ground$ is injective. Thereby making $ground^{-1}$ single-valued.

\begin{proof}
	If a pair of fluents are different that means their list of variables are different or their names are different. 
	\begin{itemize}
		\item If their names are different then by definition two different grounded fluents will be outputted by $ground$.
		
		\item If their list of variables are different, and the arguments to the action are unique. Then those pairs of lists of variables will remain different, even when each variable is mapped to an object, as all those objects are unique. Since $ground$ only performs this mapping then this must hold for $ground$.
	\end{itemize}	
	As we have proved that $ground$ can never output to the same predicate, for two different fluents when the action arguments are unique. Then it follows that $ground$ must be an injective function. 
\end{proof}
\end{lemma}

On a side note, this means it is preferable to an agent to try actions where the arguments to that action are all unique. 

If however only some of the arguments are unique, then we should still be able to prove some of the fluents, provided all other fluents that map from the same grounded fluent have been disproved. We can do this by using our disproved set $√ê$, built from earlier transitions, to discard incorrect fluents. This gives us the following theorem: 

\begin{theorem} For a state-transition $(S,a,S')$ with 
	\begin{equation*}
	\Delta S = S' \setminus S \cup \{\neg p \mid  p \in S \setminus S' \}
	\end{equation*}
	
	then, 
	 $\forall_{p \in \Delta S}$ it holds that:
	
	If $ground^{-1}$ is single-valued or it is multivalued but all except one output have been disproved, then that the fluent outputted by $ground^{-1}(p)$ is proved to be an effect.
	We can write this as a function:
	
	\begin{equation*}
	k(\Delta S) = 
	\left\{
		f \mid 
				p \in \Delta S \land 
				ground(p)^{-1} \setminus D = \{f\}
		\right\}
	\end{equation*}
	where $D$ is the set of disproved fluents.
	
	\begin{proof}
		If $ground^{-1}$ is single-valued then that means only one fluent can produce the grounded predicate observed in the state, therefore that fluent must be an actual effect.
		If $ground^{-1}$ is multivalued but all other outputs have been disproved then as before only one fluent could can produce the grounded predicate, giving us the same result which is that, the fluent is an actual effect.
	\end{proof}
\end{theorem}

\begin{example}[Proving effects in \texttt{move-h}] \label{ex:nca:moveSucceeded-proving-effects}
	Following from Example \ref{ex:nca:moveSucceeded-disproving-effects}
	We have $S_0$, $S_1$ and $\mathbb{F}$.
	
	\begin{equation*}
	\begin{split}
	\Delta S &=
	\left\{
	\begin{gathered}
	\texttt{sokobanAt}(t_2), \\
	\texttt{clear}(t_1), \\
	\neg \texttt{clear}(t_2)		
	\end{gathered}
	\right\} \\	
	k(\Delta S) &= \left\{
	\begin{gathered}
	\texttt{sokobanAt}(to), \\
	\texttt{clear}(from), \\
	\neg \texttt{clear}(to)		
	\end{gathered}
	\right\}
	\end{split}
	\end{equation*}
	We see that effects are correctly proven, such a proving the action actually moves sokoban to a new location i.e. $\texttt{sokobanAt}(to)$.
\end{example}

\end{document}
